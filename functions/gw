#!/bin/zsh
#
# gw — Git Worktree manager with iTerm pane layout
#
# Usage:
#   gw                           # list existing worktrees
#   gw <name>                    # create/navigate worktree, branch = <name>
#   gw <name> <branch>           # create/navigate worktree, checkout <branch>
#   gw <name> --no-nvim          # skip nvim pane
#   gw <name> --cl --cli         # only cl + terminal panes
#
# Layout (default 3-pane):
#   ┌──────────┬──────────┐
#   │          │  nvim .  │
#   │    cl    ├──────────┤
#   │          │ terminal │
#   └──────────┴──────────┘

# --- Parse pane flags ---
local -a layout_flags
local -a positional
local arg
for arg in "$@"; do
  case "$arg" in
    --cl|--nvim|--cli|--no-cl|--no-nvim|--no-cli)
      layout_flags+=("$arg") ;;
    *)
      positional+=("$arg") ;;
  esac
done
set -- "${positional[@]}"

# --- Resolve main worktree root ---
local main_root
main_root=$(git worktree list --porcelain 2>/dev/null | head -1 | sed 's/^worktree //')
if [[ -z "$main_root" ]]; then
  echo "gw: not a git repository" >&2
  return 1
fi

# --- No args: list worktrees ---
if [[ $# -eq 0 ]]; then
  git worktree list
  return 0
fi

local name="$1"
local branch="${2:-}"
local wt_dir="$main_root/worktrees/$name"

# --- Navigate to or create worktree ---
if [[ -d "$wt_dir" ]]; then
  cd "$wt_dir"
else
  # Confirm before creating
  echo -n "gw: worktree '$name' does not exist. Create it? [y/N] "
  read -r reply
  if [[ "$reply" != [yY] ]]; then
    return 0
  fi

  mkdir -p "$main_root/worktrees"
  if [[ -n "$branch" ]]; then
    git worktree add "$wt_dir" "$branch" || return 1
  else
    # Try existing branch first, fall back to new branch off main
    if git show-ref --verify --quiet "refs/heads/$name" 2>/dev/null || \
       git show-ref --verify --quiet "refs/remotes/origin/$name" 2>/dev/null; then
      git worktree add "$wt_dir" "$name" || return 1
    else
      git worktree add -b "$name" "$wt_dir" main || return 1
    fi
  fi
  echo "gw: created worktree at $wt_dir"
  cd "$wt_dir"
fi

# --- Symlink shared files from main worktree ---
gw-link "$wt_dir"

# --- Set up iTerm pane layout ---
if (( $+commands[gw-layout] )); then
  gw-layout "$wt_dir" "${layout_flags[@]}"
else
  echo "gw: gw-layout not found, skipping pane layout" >&2
fi
